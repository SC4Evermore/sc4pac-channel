(()=>{"use strict";var e={5:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Sc4PacPlugin=void 0;const a=n(545),s=n(363),c="X-Cached-Date";t.Sc4PacPlugin=class{channels=[];cacheMinutes=30;index={};constructor(e){const{channels:t,cacheMinutes:n}=e;this.channels=[...t],this.cacheMinutes=n||30}find(e,t){return this.index[e]?.[t]??[]}install(e){const t=this.getInstallUrl(e);window.open(t)}getInstallUrl(e){const t=[e].flat(),n=new Set,a=new URL("sc4pac:///package");for(let e of t)a.searchParams.append("pkg",e.id),n.add(e.channelUrl);for(let e of n)a.searchParams.append("channel",e);return a.toString()}getViewUrl(e){const[t]=[e].flat();return t?.getViewUrl()??"https://memo33.github.io/sc4pac/#/"}async setup(){await Promise.all([(0,s.ready)(),this.loadChannel("memo33.github.io/sc4pac/channel"),...this.channels.map((e=>this.loadChannel(e)))])}async fetchWithCache(e){const t=await window.caches.open("sc4pac-channels"),n=await t.match(e);if(n){const e=n.headers.get(c);if(e){const t=new Date(e);if((Date.now()-t.getTime())/6e4<this.cacheMinutes)return n}}const a=await fetch(e),s=a.clone(),r=new Headers(s.headers);r.set(c,(new Date).toISOString());const l=new Response(s.body,{status:s.status,statusText:s.statusText,headers:r});return await t.put(e,l),a}async loadChannel(e){const{index:t}=this,n=`https://${e}/sc4pac-channel-contents.json`,s=await this.fetchWithCache(n),c=await s.json();for(let n of c.packages){const s=n.externalIds||{};for(let[c,r]of Object.entries(s)){const s=t[c]??={};for(let t of r)(s[t]??=[]).push(new a.Package({channelUrl:`https://${e}`,...n}))}}}}},363:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ready=async function(){return new Promise((e=>{"complete"===document.readyState||"interactive"===document.readyState?e(void 0):document.addEventListener("DOMContentLoaded",(()=>e(void 0)))}))},t.h=function(e,t={},n=[]){const a=document.createElement(e);Array.isArray(n)||(n=[n]);for(let e of n){"string"==typeof e?a.appendChild(new Text(e)):a.appendChild(e);for(let e of Object.keys(t))a.setAttribute(e,t[e])}return a},t.getIdFromUrl=function(e=window.location.href){const{pathname:t}=new URL(e);if(t.startsWith("/index.php/downloads/download"))return t.replace(/\/$/,"").split("/").reverse()[0]?.split("-")[0]}},545:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Package=void 0,t.Package=class{id;channelUrl;constructor(e){const{group:t,name:n}=e;this.id=`${t}:${n}`,this.channelUrl=`${e.channelUrl.replace(/\/^/,"")}/`}getInstallPayload(){return{package:this.id,channelUrl:this.channelUrl}}getInstallUrl(){const e=new URL("sc4pac:///package");return e.searchParams.set("pkg",this.id),e.searchParams.set("channel",this.channelUrl),e.href}getViewUrl(){const e=new URL("https://memo33.github.io/sc4pac/channel");return e.searchParams.set("pkg",this.id),e.searchParams.set("channel",this.channelUrl),e.href}}}},t={};function n(a){var s=t[a];if(void 0!==s)return s.exports;var c=t[a]={exports:{}};return e[a](c,c.exports,n),c.exports}(()=>{const e=n(5),t=n(363),a="sc4evermore.github.io/sc4pac-channel/channel";(async function(n){Array.isArray(n)&&(n={channels:n});const a=new e.Sc4PacPlugin(n);return await a.setup(),{plugin:a,h:t.h}})([a]).then((({plugin:e,h:n})=>{let s=(0,t.getIdFromUrl)();if(!s)return;let c=e.find("sc4e",s);if(0===c.length)return;c.sort(((e,t)=>(e.channelUrl.includes(a)?1:-1)-(t.channelUrl.includes(a)?1:-1)));const r=new Map;for(let e of c)r.set(e.id,e);c=[...r.values()];const l=n("a",{href:e.getInstallUrl(c),id:"install-sc4pac",class:"jdbutton jblack"},["Download with SC4Pac"]),i=[...document.querySelectorAll("a.jdbutton")].find((e=>{const t=e.getAttribute("href");if(!t)return!1;try{return"download.send"===new URL(t,"https://www.sc4evermore.com/").searchParams.get("task")}catch{return!1}}));if(!i)return;const o=n("li",{},[l]),h=i.closest("ul");h?.appendChild(o),h?.appendChild(n("li",{style:"text-align: center"},[n("a",{href:e.getViewUrl(c),target:"_blank",style:"text-decoration: underline; font-size: 8pt"},["View on sc4pac website"])]))}))})()})();